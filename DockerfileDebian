FROM ubuntu:18.04 as builder

ENV SRC_DIR ~/GraftNetwork

ENV BUILD_PACKAGES ca-certificates git build-essential cmake pkg-config libboost-all-dev libssl-dev autoconf automake check libpcre3-dev rapidjson-dev libreadline-dev

RUN apt update && apt install --no-install-recommends -y $BUILD_PACKAGES && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* && \
        cd $HOME && \
        git clone --recursive https://github.com/jagerman/GraftNetwork.git && \
        cd GraftNetwork && \
        git checkout multi-sn && \
        git submodule update --init --recursive

RUN cd && \
        mkdir -p ~/supernode/bin && \
        cd ~/supernode/bin && \
        cmake -DENABLE_SYSLOG=ON $SRC_DIR && \
        make

RUN mkdir //opt/bin && \
        cd ~/supernode/bin/bin && \
        cp ** //opt/bin

RUN cd /opt && git clone https://github.com/MustDie95/graft.git && \
        cp -r /opt/graft/supervisor/etc/supervisor/ /etc/

#############################

FROM debian:stable-slim as production

RUN apk update && apk add --no-cache supervisor

RUN mkdir /root/.graft && mkdir /root/opt/bin

COPY --from=builder /etc/supervisor/ /etc/supervisor

RUN rm -rf /var/lib/apt/lists/* rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

COPY --from=builder //opt/bin/graftnoded /root/opt

COPY --from=builder //opt/bin/graft-supernode /root/opt

COPY --from=builder //opt/bin/graft-wallet-cli /root/opt

EXPOSE 28680

WORKDIR /root/opt

CMD ["/usr/bin/supervisord", "-n", "-c", "/etc/supervisor/supervisord.conf"]